<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify Pulse ‚Äî Tus Canciones</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060810;
    --surface: #0d1117;
    --surface2: #131921;
    --border: rgba(255,255,255,0.07);
    --green: #1DB954;
    --green-dim: rgba(29,185,84,0.15);
    --green-glow: rgba(29,185,84,0.4);
    --text: #e8eaf0;
    --muted: #6b7280;
    --accent: #c084fc;
    --accent2: #38bdf8;
    --red: #f87171;
    --yellow: #fbbf24;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; min-height:100vh; overflow-x:hidden; }
  body::before { content:''; position:fixed; inset:0; background-image:linear-gradient(rgba(29,185,84,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(29,185,84,0.03) 1px,transparent 1px); background-size:60px 60px; pointer-events:none; z-index:0; }
  body::after { content:''; position:fixed; top:-40%; left:-20%; width:60%; height:80%; background:radial-gradient(ellipse,rgba(29,185,84,0.06) 0%,transparent 70%); pointer-events:none; z-index:0; animation:drift 20s ease-in-out infinite alternate; }
  @keyframes drift { from{transform:translate(0,0) scale(1)} to{transform:translate(10%,5%) scale(1.1)} }

  header { position:relative; z-index:10; padding:1.5rem 3rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); backdrop-filter:blur(10px); }
  .logo { display:flex; align-items:center; gap:.75rem; font-size:1.3rem; font-weight:800; letter-spacing:-.03em; }
  .logo svg { color:var(--green); }
  .logo-dot { display:inline-block; width:8px; height:8px; background:var(--green); border-radius:50%; animation:pulse-dot 2s ease-in-out infinite; margin-left:4px; }
  @keyframes pulse-dot { 0%,100%{box-shadow:0 0 0 0 var(--green-glow)} 50%{box-shadow:0 0 0 8px transparent} }

  /* AUTH */
  #auth-screen { position:relative; z-index:5; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:calc(100vh - 80px); padding:2rem; text-align:center; }
  .auth-card { background:var(--surface); border:1px solid var(--border); border-radius:24px; padding:3.5rem 4rem; max-width:520px; width:100%; position:relative; overflow:hidden; }
  .auth-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,transparent,var(--green),transparent); animation:scan 3s linear infinite; }
  @keyframes scan { from{transform:translateX(-100%)} to{transform:translateX(100%)} }
  .auth-icon { width:80px; height:80px; background:var(--green-dim); border:1px solid var(--green-glow); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 2rem; color:var(--green); font-size:2rem; }
  .auth-title { font-size:2rem; font-weight:800; letter-spacing:-.04em; margin-bottom:.75rem; background:linear-gradient(135deg,#fff 40%,var(--green)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .auth-desc { color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:.85rem; line-height:1.7; margin-bottom:2.5rem; }
  .btn-spotify { display:inline-flex; align-items:center; gap:.75rem; background:var(--green); color:#000; font-family:'Syne',sans-serif; font-weight:700; font-size:1rem; padding:1rem 2.5rem; border-radius:100px; border:none; cursor:pointer; transition:all .3s; text-decoration:none; letter-spacing:.02em; }
  .btn-spotify:hover { background:#22e065; transform:translateY(-2px); box-shadow:0 12px 40px var(--green-glow); }
  .auth-note { margin-top:1.5rem; font-size:.75rem; color:var(--muted); font-family:'JetBrains Mono',monospace; }

  /* SETUP */
  #setup-screen { position:relative; z-index:5; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:calc(100vh - 80px); padding:2rem; }
  .setup-card { background:var(--surface); border:1px solid var(--border); border-radius:24px; padding:3rem; max-width:600px; width:100%; }
  .setup-title { font-size:1.5rem; font-weight:800; letter-spacing:-.03em; margin-bottom:.5rem; }
  .setup-sub { color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:.8rem; margin-bottom:2rem; }
  .form-group { margin-bottom:1.5rem; }
  label { display:block; font-size:.8rem; font-weight:600; letter-spacing:.08em; text-transform:uppercase; color:var(--muted); margin-bottom:.5rem; }
  input,select { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); font-family:'JetBrains Mono',monospace; font-size:.9rem; padding:.875rem 1.25rem; border-radius:12px; outline:none; transition:border-color .2s; }
  input:focus,select:focus { border-color:var(--green); }
  select option { background:var(--surface2); }
  .btn-primary { width:100%; background:var(--green); color:#000; font-family:'Syne',sans-serif; font-weight:700; font-size:1rem; padding:1rem; border-radius:12px; border:none; cursor:pointer; transition:all .3s; margin-top:.5rem; }
  .btn-primary:hover { background:#22e065; transform:translateY(-1px); }
  .steps-hint { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:1.25rem; margin-bottom:2rem; }
  .steps-hint h4 { font-size:.8rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--green); margin-bottom:.75rem; }
  .steps-hint p { font-family:'JetBrains Mono',monospace; font-size:.75rem; color:var(--muted); line-height:1.8; }
  .steps-hint a { color:var(--green); }

  /* DASHBOARD */
  #dashboard { position:relative; z-index:5; padding:2.5rem 3rem; max-width:1400px; margin:0 auto; }
  .dash-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:2.5rem; flex-wrap:wrap; gap:1rem; }
  .user-info { display:flex; align-items:center; gap:1rem; }
  .user-avatar { width:52px; height:52px; border-radius:50%; border:2px solid var(--green); object-fit:cover; }
  .user-avatar-placeholder { width:52px; height:52px; border-radius:50%; border:2px solid var(--green); background:var(--green-dim); display:flex; align-items:center; justify-content:center; color:var(--green); font-weight:800; font-size:1.2rem; }
  .user-name { font-size:1.2rem; font-weight:700; }
  .user-meta { font-size:.78rem; color:var(--muted); font-family:'JetBrains Mono',monospace; }
  .controls { display:flex; gap:.75rem; flex-wrap:wrap; }
  .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text); font-family:'Syne',sans-serif; font-size:.82rem; font-weight:600; padding:.5rem 1.25rem; border-radius:100px; cursor:pointer; transition:all .2s; letter-spacing:.03em; }
  .btn-outline:hover { border-color:var(--green); color:var(--green); }
  .btn-outline.active { background:var(--green-dim); border-color:var(--green); color:var(--green); }

  /* NAV TABS */
  .nav-tabs { display:flex; gap:.5rem; margin-bottom:2rem; border-bottom:1px solid var(--border); padding-bottom:0; }
  .nav-tab { background:transparent; border:none; border-bottom:2px solid transparent; color:var(--muted); font-family:'Syne',sans-serif; font-size:.9rem; font-weight:600; padding:.75rem 1.5rem; cursor:pointer; transition:all .2s; margin-bottom:-1px; }
  .nav-tab:hover { color:var(--text); }
  .nav-tab.active { color:var(--green); border-bottom-color:var(--green); }

  /* STATS */
  .stats-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; margin-bottom:2.5rem; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:1.25rem 1.5rem; position:relative; overflow:hidden; }
  .stat-card::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:var(--green); transform:scaleX(0); transition:transform .3s; transform-origin:left; }
  .stat-card:hover::after { transform:scaleX(1); }
  .stat-label { font-size:.72rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); margin-bottom:.5rem; }
  .stat-value { font-size:1.6rem; font-weight:800; letter-spacing:-.03em; color:var(--green); }
  .stat-sub { font-size:.75rem; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:.25rem; }

  /* TRACKS */
  .section-title { font-size:.78rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:1.25rem; }
  .tracks-grid { display:grid; gap:.75rem; }
  .track-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:1.25rem 1.5rem; display:grid; grid-template-columns:40px 60px 1fr auto; align-items:center; gap:1.25rem; cursor:pointer; transition:all .2s; position:relative; overflow:hidden; }
  .track-card:hover { border-color:rgba(29,185,84,.3); background:var(--surface2); transform:translateX(4px); }
  .track-card.expanded { border-color:var(--green); background:var(--surface2); }
  .track-rank { font-family:'JetBrains Mono',monospace; font-size:1rem; font-weight:500; color:var(--muted); text-align:center; }
  .track-rank.top3 { color:var(--green); font-weight:700; font-size:1.1rem; }
  .track-cover { width:60px; height:60px; border-radius:10px; object-fit:cover; flex-shrink:0; }
  .track-cover-placeholder { width:60px; height:60px; border-radius:10px; background:var(--green-dim); display:flex; align-items:center; justify-content:center; color:var(--green); font-size:1.5rem; flex-shrink:0; }
  .track-info { min-width:0; }
  .track-name { font-size:1rem; font-weight:700; letter-spacing:-.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .track-artist { font-size:.82rem; color:var(--muted); font-family:'JetBrains Mono',monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:.2rem; }
  .track-meta { text-align:right; flex-shrink:0; }
  .pop-bar { display:flex; align-items:center; gap:.5rem; justify-content:flex-end; }
  .pop-track { width:60px; height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
  .pop-fill { height:100%; background:var(--green); border-radius:2px; transition:width .8s ease; }
  .pop-num { font-family:'JetBrains Mono',monospace; font-size:.75rem; color:var(--muted); min-width:28px; }

  /* EXPANDED */
  .track-details { display:none; grid-column:1/-1; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border); }
  .track-card.expanded .track-details { display:block; }
  .details-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:.75rem; margin-bottom:1.25rem; }
  .detail-chip { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:.625rem .875rem; }
  .detail-chip-label { font-size:.65rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); margin-bottom:.3rem; }
  .detail-chip-value { font-family:'JetBrains Mono',monospace; font-size:.88rem; font-weight:500; color:var(--text); }
  .features-section { margin-bottom:1.25rem; }
  .features-title { font-size:.7rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:.75rem; }
  .feature-row { display:flex; align-items:center; gap:.875rem; margin-bottom:.5rem; }
  .feature-name { font-size:.75rem; font-family:'JetBrains Mono',monospace; color:var(--muted); min-width:100px; }
  .feature-bar { flex:1; height:6px; background:var(--border); border-radius:3px; overflow:hidden; }
  .feature-fill { height:100%; border-radius:3px; transition:width .8s ease .1s; }
  .feature-val { font-size:.72rem; font-family:'JetBrains Mono',monospace; color:var(--muted); min-width:35px; text-align:right; }
  .lyrics-section { margin-top:1rem; }
  .lyrics-title { font-size:.7rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:.75rem; }
  .lyrics-content { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:1rem 1.25rem; font-family:'JetBrains Mono',monospace; font-size:.8rem; line-height:1.9; color:var(--muted); max-height:200px; overflow-y:auto; white-space:pre-wrap; }
  .lyrics-content::-webkit-scrollbar { width:4px; }
  .lyrics-content::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  .btn-fetch-lyrics { background:var(--surface2); border:1px solid var(--border); color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:.8rem; padding:.5rem 1rem; border-radius:8px; cursor:pointer; transition:all .2s; }
  .btn-fetch-lyrics:hover { border-color:var(--accent); color:var(--accent); }
  .genre-badge { display:inline-block; background:rgba(192,132,252,.15); border:1px solid rgba(192,132,252,.3); color:var(--accent); font-size:.7rem; font-family:'JetBrains Mono',monospace; padding:.2rem .6rem; border-radius:100px; margin:.2rem; }

  /* WRAPPED */
  #wrapped-section { display:none; }
  #wrapped-section.visible { display:block; }
  .wrapped-hero { text-align:center; padding:3rem 1rem 2rem; }
  .wrapped-year { font-size:5rem; font-weight:800; letter-spacing:-.05em; background:linear-gradient(135deg,var(--green),var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1; }
  .wrapped-subtitle { font-size:1rem; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:.5rem; }
  .wrapped-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1.5rem; margin-bottom:2rem; align-items:start; }
  .wrapped-card {
    background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:2rem;
    position:relative; overflow:visible;
    transform:scale(1); transition:transform .3s ease, box-shadow .3s ease, border-color .3s ease, background .3s ease;
    cursor:default;
  }
  .wrapped-card::after { content:''; position:absolute; inset:0; border-radius:20px; pointer-events:none; }
  .wrapped-card:hover {
    transform:scale(1.03);
    box-shadow:0 16px 48px rgba(0,0,0,.4);
    border-color:rgba(255,255,255,.15);
    background:var(--surface2);
    z-index:2;
  }
  .wrapped-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; border-radius:20px 20px 0 0; }
  .wrapped-card.green::before { background:linear-gradient(90deg,var(--green),transparent); }
  .wrapped-card.green:hover { border-color:rgba(29,185,84,.4); box-shadow:0 16px 48px rgba(29,185,84,.15); }
  .wrapped-card.purple::before { background:linear-gradient(90deg,var(--accent),transparent); }
  .wrapped-card.purple:hover { border-color:rgba(192,132,252,.4); box-shadow:0 16px 48px rgba(192,132,252,.15); }
  .wrapped-card.blue::before { background:linear-gradient(90deg,var(--accent2),transparent); }
  .wrapped-card.blue:hover { border-color:rgba(56,189,248,.4); box-shadow:0 16px 48px rgba(56,189,248,.15); }
  .wrapped-card.yellow::before { background:linear-gradient(90deg,var(--yellow),transparent); }
  .wrapped-card.yellow:hover { border-color:rgba(251,191,36,.4); box-shadow:0 16px 48px rgba(251,191,36,.15); }
  .wrapped-card-icon { font-size:2.5rem; margin-bottom:1rem; }
  .wrapped-card-label { font-size:.72rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:.5rem; }
  .wrapped-card-value { font-size:1.8rem; font-weight:800; letter-spacing:-.03em; margin-bottom:.25rem; }
  .wrapped-card-sub { font-size:.82rem; color:var(--muted); font-family:'JetBrains Mono',monospace; }
  .wrapped-top-list { list-style:none; }
  .wrapped-top-list li { display:flex; align-items:center; gap:1rem; padding:.625rem 0; border-bottom:1px solid var(--border); }
  .wrapped-top-list li:last-child { border-bottom:none; }
  .wrapped-num { font-family:'JetBrains Mono',monospace; font-size:.8rem; color:var(--muted); min-width:20px; }
  .wrapped-thumb { width:40px; height:40px; border-radius:8px; object-fit:cover; }
  .wrapped-thumb-placeholder { width:40px; height:40px; border-radius:8px; background:var(--green-dim); display:flex; align-items:center; justify-content:center; color:var(--green); }
  .wrapped-item-info { flex:1; min-width:0; }
  .wrapped-item-name { font-size:.88rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .wrapped-item-sub { font-size:.75rem; color:var(--muted); font-family:'JetBrains Mono',monospace; }
  .genre-chart { margin-top:1rem; }
  .genre-row { display:flex; align-items:center; gap:.75rem; margin-bottom:.625rem; }
  .genre-label { font-size:.78rem; font-family:'JetBrains Mono',monospace; color:var(--text); min-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .genre-bar-wrap { flex:1; height:8px; background:var(--border); border-radius:4px; overflow:hidden; }
  .genre-bar-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--green),var(--accent)); transition:width 1s ease; }
  .genre-pct { font-size:.72rem; font-family:'JetBrains Mono',monospace; color:var(--muted); min-width:35px; text-align:right; }
  .decade-chart { display:flex; gap:.75rem; align-items:flex-end; height:120px; margin-top:1.25rem; padding:0 .25rem; }
  .decade-col { flex:1; display:flex; flex-direction:column; align-items:center; gap:.4rem; }
  .decade-bar-wrap { width:100%; display:flex; align-items:flex-end; height:80px; }
  .decade-bar { width:100%; background:linear-gradient(180deg,var(--green),rgba(29,185,84,.3)); border-radius:6px 6px 0 0; transition:height .8s ease; position:relative; min-height:8px; }
  .decade-bar:hover { background:linear-gradient(180deg,#22e065,rgba(34,224,101,.4)); }
  .decade-cnt { font-size:.7rem; font-family:'JetBrains Mono',monospace; color:var(--green); font-weight:600; }
  .decade-label { font-size:.65rem; font-family:'JetBrains Mono',monospace; color:var(--muted); }

  /* LOADING */
  .loading { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:5rem; gap:1.5rem; }
  .spinner { width:48px; height:48px; border:3px solid var(--border); border-top-color:var(--green); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-text { font-family:'JetBrains Mono',monospace; font-size:.85rem; color:var(--muted); animation:blink 1.5s ease-in-out infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

  /* MISC */
  .error-box { background:rgba(248,113,113,.1); border:1px solid rgba(248,113,113,.3); border-radius:12px; padding:1.25rem; font-family:'JetBrains Mono',monospace; font-size:.82rem; color:var(--red); margin:1rem 0; }
  /* RECOMMENDATIONS */
  .rec-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1rem; }
  .rec-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:1.25rem; display:flex; flex-direction:column; gap:.75rem; transition:all .2s; }
  .rec-card:hover { border-color:rgba(29,185,84,.3); transform:translateY(-2px); }
  .rec-header { display:flex; align-items:center; gap:.875rem; }
  .rec-cover { width:56px; height:56px; border-radius:10px; object-fit:cover; flex-shrink:0; }
  .rec-cover-ph { width:56px; height:56px; border-radius:10px; background:var(--green-dim); display:flex; align-items:center; justify-content:center; color:var(--green); font-size:1.4rem; flex-shrink:0; }
  .rec-info { flex:1; min-width:0; }
  .rec-name { font-size:.95rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .rec-artist { font-size:.78rem; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:.15rem; }
  .rec-reason { font-size:.75rem; color:var(--accent); font-family:'JetBrains Mono',monospace; background:rgba(192,132,252,.1); border:1px solid rgba(192,132,252,.2); border-radius:8px; padding:.4rem .75rem; }
  .rec-pop { display:flex; align-items:center; gap:.5rem; }
  .rec-pop-label { font-size:.7rem; color:var(--muted); font-family:'JetBrains Mono',monospace; }
  .rec-section-title { font-size:.78rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:1rem; margin-top:1.5rem; }
  .rec-section-title:first-child { margin-top:0; }
  /* FILTERS */
  .filter-bar { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; margin-bottom:1.5rem; padding:1rem 1.25rem; background:var(--surface); border:1px solid var(--border); border-radius:16px; }
  .filter-label { font-size:.72rem; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); white-space:nowrap; }
  .filter-chip { background:var(--surface2); border:1px solid var(--border); color:var(--muted); font-family:'Syne',sans-serif; font-size:.78rem; font-weight:600; padding:.4rem 1rem; border-radius:100px; cursor:pointer; transition:all .2s; white-space:nowrap; }
  .filter-chip:hover { border-color:var(--green); color:var(--text); }
  .filter-chip.active { background:var(--green-dim); border-color:var(--green); color:var(--green); }
  .filter-divider { width:1px; height:20px; background:var(--border); flex-shrink:0; }
  .filter-order { background:var(--surface2); border:1px solid var(--border); color:var(--text); font-family:'JetBrains Mono',monospace; font-size:.78rem; padding:.4rem .75rem; border-radius:100px; cursor:pointer; outline:none; }
  .filter-search { background:var(--surface2); border:1px solid var(--border); color:var(--text); font-family:'JetBrains Mono',monospace; font-size:.82rem; padding:.4rem 1rem; border-radius:100px; outline:none; flex:1; min-width:140px; max-width:220px; transition:border-color .2s; }
  .filter-search:focus { border-color:var(--green); }
  .filter-search::placeholder { color:var(--muted); }
  .tracks-count { font-size:.75rem; font-family:'JetBrains Mono',monospace; color:var(--muted); margin-bottom:.75rem; }

  /* HIDDEN GEMS */
  .gems-hero { text-align:center; padding:2rem 1rem 1.5rem; }
  .gems-title { font-size:2rem; font-weight:800; letter-spacing:-.04em; background:linear-gradient(135deg,var(--yellow),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .gems-sub { font-size:.85rem; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:.5rem; }
  .gems-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:1rem; }
  .gem-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:1.25rem; display:flex; flex-direction:column; gap:.75rem; transition:all .2s; position:relative; overflow:hidden; }
  .gem-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,var(--yellow),var(--accent),transparent); }
  .gem-card:hover { transform:translateY(-3px); box-shadow:0 12px 40px rgba(251,191,36,.15); border-color:rgba(251,191,36,.3); }
  .gem-header { display:flex; align-items:center; gap:.875rem; }
  .gem-cover { width:56px; height:56px; border-radius:10px; object-fit:cover; flex-shrink:0; }
  .gem-cover-ph { width:56px; height:56px; border-radius:10px; background:rgba(251,191,36,.1); display:flex; align-items:center; justify-content:center; font-size:1.4rem; flex-shrink:0; }
  .gem-info { flex:1; min-width:0; }
  .gem-name { font-size:.95rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .gem-artist { font-size:.78rem; color:var(--muted); font-family:'JetBrains Mono',monospace; margin-top:.15rem; }
  .gem-why { font-size:.75rem; color:var(--yellow); font-family:'JetBrains Mono',monospace; background:rgba(251,191,36,.08); border:1px solid rgba(251,191,36,.2); border-radius:8px; padding:.4rem .75rem; }
  .gem-stats { display:flex; gap:.75rem; flex-wrap:wrap; }
  .gem-stat { font-size:.72rem; font-family:'JetBrains Mono',monospace; color:var(--muted); background:var(--surface2); padding:.25rem .6rem; border-radius:6px; }
  .hidden { display:none !important; }
  .toast { position:fixed; bottom:2rem; right:2rem; background:var(--surface); border:1px solid var(--green); color:var(--text); font-family:'JetBrains Mono',monospace; font-size:.82rem; padding:.875rem 1.5rem; border-radius:12px; z-index:1000; opacity:0; transform:translateY(20px); transition:all .3s; }
  .toast.show { opacity:1; transform:translateY(0); }
  .btn-export { background:rgba(56,189,248,.1); border:1px solid rgba(56,189,248,.3); color:var(--accent2); font-family:'Syne',sans-serif; font-size:.82rem; font-weight:600; padding:.5rem 1.25rem; border-radius:100px; cursor:pointer; transition:all .2s; }
  .btn-export:hover { background:rgba(56,189,248,.2); }
  @media(max-width:768px) { header{padding:1.25rem 1.5rem} #dashboard{padding:1.5rem} .track-card{grid-template-columns:30px 48px 1fr} .track-meta{display:none} .auth-card{padding:2rem 1.5rem} }
</style>
</head>
<body>

<header>
  <div class="logo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424a.622.622 0 01-.857.207c-2.348-1.435-5.304-1.76-8.785-.964a.622.622 0 01-.277-1.215c3.809-.87 7.076-.496 9.712 1.115a.622.622 0 01.207.857zm1.223-2.722a.779.779 0 01-1.072.257c-2.687-1.652-6.785-2.13-9.965-1.166a.78.78 0 01-.973-.52.78.78 0 01.52-.973c3.632-1.102 8.147-.568 11.233 1.329a.779.779 0 01.257 1.073zm.105-2.835C14.692 8.95 9.375 8.775 6.297 9.71a.935.935 0 11-.543-1.79c3.532-1.072 9.404-.865 13.115 1.338a.935.935 0 01-.955 1.609z"/>
    </svg>
    Spotify Pulse<span class="logo-dot"></span>
  </div>
  <div id="header-actions"></div>
</header>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-icon">üéµ</div>
    <h1 class="auth-title">Analiza tu m√∫sica</h1>
    <p class="auth-desc">Conecta tu cuenta de Spotify para ver an√°lisis detallados<br>de tus canciones m√°s escuchadas.</p>
    <button class="btn-spotify" onclick="startAuth()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424a.622.622 0 01-.857.207c-2.348-1.435-5.304-1.76-8.785-.964a.622.622 0 01-.277-1.215c3.809-.87 7.076-.496 9.712 1.115a.622.622 0 01.207.857zm1.223-2.722a.779.779 0 01-1.072.257c-2.687-1.652-6.785-2.13-9.965-1.166a.78.78 0 01-.973-.52.78.78 0 01.52-.973c3.632-1.102 8.147-.568 11.233 1.329a.779.779 0 01.257 1.073zm.105-2.835C14.692 8.95 9.375 8.775 6.297 9.71a.935.935 0 11-.543-1.79c3.532-1.072 9.404-.865 13.115 1.338a.935.935 0 01-.955 1.609z"/></svg>
      Conectar con Spotify
    </button>
    <p class="auth-note">Inicia sesi√≥n con tu cuenta de Spotify</p>
  </div>
</div>

<!-- SETUP -->
<div id="setup-screen" class="hidden">
  <div class="setup-card">
    <h2 class="setup-title">Configuraci√≥n</h2>
    <p class="setup-sub">Credenciales de Spotify Developer</p>
    <div class="steps-hint">
      <h4>üìã C√≥mo obtener tu Client ID</h4>
      <p>1. Ve a <a href="https://developer.spotify.com/dashboard" target="_blank">developer.spotify.com/dashboard</a><br>
      2. Crea una nueva App<br>
      3. Agrega como Redirect URI: <strong id="redirect-display"></strong><br>
      4. Copia tu Client ID</p>
    </div>
    <div class="form-group">
      <label>Client ID de Spotify</label>
      <input type="text" id="client-id-input" placeholder="Pega aqu√≠ tu Client ID..." />
    </div>
    <div id="setup-error" class="error-box hidden"></div>
    <button class="btn-primary" onclick="doAuth()">Conectar con Spotify ‚Üí</button>
    <button class="btn-outline" style="width:100%;margin-top:.75rem;" onclick="showAuth()">‚Üê Volver</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p class="loading-text">Cargando tus canciones...</p>
  </div>
  <div id="content" class="hidden">
    <div class="dash-header">
      <div class="user-info">
        <div id="user-avatar-wrap"></div>
        <div>
          <div class="user-name" id="user-display-name">‚Äî</div>
          <div class="user-meta" id="user-meta">‚Äî</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn-outline active" onclick="setRange('short_term',this)">1 mes</button>
        <button class="btn-outline" onclick="setRange('medium_term',this)">6 meses</button>
        <button class="btn-outline" onclick="setRange('long_term',this)">Todo</button>
        <button class="btn-export" onclick="exportData()">‚¨á Exportar JSON</button>
        <button class="btn-outline" onclick="logout()" style="color:var(--red);border-color:rgba(248,113,113,.3);">Salir</button>
      </div>
    </div>

    <!-- NAV TABS -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('tracks',this)">üéµ Mis Canciones</button>
      <button class="nav-tab" onclick="showTab('wrapped',this)">üéÅ Mi Wrapped</button>
      <button class="nav-tab" onclick="showTab('recs',this)">üî≠ Descubre</button>
      <button class="nav-tab" onclick="showTab('gems',this)">üíé Gemas</button>
    </div>

    <!-- TRACKS TAB -->
    <div id="tracks-tab">
      <div class="stats-row" id="stats-row"></div>

      <!-- FILTER BAR -->
      <div class="filter-bar">
        <span class="filter-label">Ordenar:</span>
        <button class="filter-chip active" onclick="applyFilter('rank',this)">üèÜ Mi Top</button>
        <button class="filter-chip" onclick="applyFilter('popularity',this)">üë• Oyentes</button>
        <button class="filter-chip" onclick="applyFilter('year',this)">üìÖ A√±o</button>
        <button class="filter-chip" onclick="applyFilter('duration',this)">‚è± Duraci√≥n</button>
        <button class="filter-chip" onclick="applyFilter('bpm',this)">ü•Å BPM</button>
        <button class="filter-chip" onclick="applyFilter('name',this)">üî§ A-Z</button>
        <div class="filter-divider"></div>
        <select class="filter-order" id="filter-order" onchange="applyCurrentFilter()">
          <option value="desc">‚Üì Mayor a menor</option>
          <option value="asc">‚Üë Menor a mayor</option>
        </select>
        <div class="filter-divider"></div>
        <input class="filter-search" id="filter-search" placeholder="üîç Buscar canci√≥n..." oninput="applyCurrentFilter()">
      </div>

      <div class="tracks-count" id="tracks-count"></div>
      <p class="section-title">Top Canciones ‚Äî <span id="range-label">√öltimo mes</span></p>
      <div class="tracks-grid" id="tracks-grid"></div>
    </div>

    <!-- GEMS TAB -->
    <div id="gems-tab" class="hidden">
      <div class="gems-hero">
        <div class="gems-title">üíé Tus Gemas Escondidas</div>
        <div class="gems-sub">Canciones √∫nicas que pocas personas conocen ‚Äî tu gusto musical secreto</div>
      </div>
      <div id="gems-grid" class="gems-grid"></div>
    </div>

    <!-- RECS TAB -->
    <div id="recs-tab" class="hidden">
      <div id="recs-loading" class="loading hidden">
        <div class="spinner"></div>
        <p class="loading-text">Buscando canciones para ti...</p>
      </div>
      <div id="recs-content"></div>
    </div>

    <!-- WRAPPED TAB -->
    <div id="wrapped-tab" class="hidden">
      <div class="wrapped-hero">
        <div class="wrapped-year" id="wrapped-year">2025</div>
        <div class="wrapped-subtitle">Tu resumen musical personal</div>
      </div>
      <div class="wrapped-grid" id="wrapped-grid"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<footer style="position:relative;z-index:5;text-align:center;padding:1.5rem;border-top:1px solid rgba(255,255,255,0.07);margin-top:2rem;">
  <p style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:#6b7280;">
    BPM data by <a href="https://getsongbpm.com" target="_blank" rel="dofollow" style="color:var(--green)">GetSongBPM</a>
    &nbsp;¬∑&nbsp; Genres by <a href="https://last.fm" target="_blank" style="color:var(--green)">Last.fm</a>
    &nbsp;¬∑&nbsp; Music by <a href="https://spotify.com" target="_blank" style="color:var(--green)">Spotify</a>
  </p>
</footer>

<script>
// ===== CONFIG =====
const CLIENT_ID = 'f1d1a7deb2f04f038787128a2fd4516a';
const LASTFM_KEY = '6c708f592f3f69bcfb89c9a119c07fbb';
const REDIRECT_URI = window.location.href.split('?')[0].split('#')[0];
const SCOPES = 'user-top-read user-read-private user-read-email';

let accessToken = null;
let tracksData = [];
let audioFeaturesData = {};
let currentRange = 'short_term';

// ===== LISTENERS ESTIMATOR =====
// Spotify popularity 0-100 ‚Üí estimated real listeners (monthly approx)
function estimateListeners(pop) {
  if (pop == null) return null;
  // Exponential scale: pop 100 ~ 80M monthly, pop 0 ~ 1K
  // Formula: listeners = 1000 * e^(pop * 0.115)
  const est = Math.round(1000 * Math.exp(pop * 0.115));
  return est;
}

function formatListeners(pop) {
  const n = estimateListeners(pop);
  if (!n) return '‚Äî';
  if (n >= 1_000_000_000) return (n/1_000_000_000).toFixed(1) + 'B';
  if (n >= 1_000_000) return (n/1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n/1_000).toFixed(0) + 'K';
  return n.toString();
}

// ===== PKCE =====
function generateRandom(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  const array = new Uint8Array(length);
  crypto.getRandomValues(array);
  return Array.from(array, b => chars[b % chars.length]).join('');
}
async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

// ===== INIT =====
window.onload = async function() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (params.get('error')) { showAuth(); return; }
  if (code) {
    history.replaceState(null,'',window.location.pathname);
    await exchangeCode(code);
    return;
  }
  const stored = sessionStorage.getItem('sp_token');
  const expiry = sessionStorage.getItem('sp_expiry');
  if (stored && expiry && Date.now() < parseInt(expiry)) {
    accessToken = stored;
    showDashboard();
    return;
  }
  showAuth();
};

async function exchangeCode(code) {
  const verifier = sessionStorage.getItem('pkce_verifier');
  if (!verifier) { showAuth(); return; }
  try {
    const res = await fetch('https://accounts.spotify.com/api/token', {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({ grant_type:'authorization_code', code, redirect_uri:REDIRECT_URI, client_id:CLIENT_ID, code_verifier:verifier })
    });
    const data = await res.json();
    if (data.access_token) {
      accessToken = data.access_token;
      sessionStorage.setItem('sp_token', accessToken);
      sessionStorage.setItem('sp_expiry', Date.now() + data.expires_in * 1000);
      sessionStorage.removeItem('pkce_verifier');
      showDashboard();
    } else {
      showAuth();
      alert('Error al obtener token: ' + (data.error_description || data.error));
    }
  } catch(e) { showAuth(); alert('Error: ' + e.message); }
}

// ===== SCREENS =====
function showAuth() {
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('setup-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.add('hidden');
}

async function startAuth() {
  if (!CLIENT_ID || CLIENT_ID === 'TU_CLIENT_ID_AQUI') { alert('‚ö† Client ID no configurado.'); return; }
  const verifier = generateRandom(64);
  const challenge = await generateCodeChallenge(verifier);
  sessionStorage.setItem('pkce_verifier', verifier);
  const authUrl = 'https://accounts.spotify.com/authorize?' + new URLSearchParams({
    client_id:CLIENT_ID, response_type:'code', redirect_uri:REDIRECT_URI,
    scope:SCOPES, state:generateRandom(16), code_challenge_method:'S256',
    code_challenge:challenge, show_dialog:'true'
  });
  window.location.href = authUrl;
}

function showDashboard() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('setup-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('content').classList.add('hidden');
  const tr = sessionStorage.getItem('sp_range') || 'short_term';
  currentRange = tr;
  updateRangeButtons(tr);
  loadData();
}

function logout() { sessionStorage.clear(); accessToken=null; tracksData=[]; showAuth(); }

function doAuth() {
  const cid = document.getElementById('client-id-input').value.trim();
  if (!cid) { document.getElementById('setup-error').textContent='Ingresa tu Client ID'; document.getElementById('setup-error').classList.remove('hidden'); return; }
  localStorage.setItem('sp_client_id', cid);
  startAuth();
}

// ===== TABS =====
function showTab(tab, btn) {
  document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tracks-tab').classList.toggle('hidden', tab !== 'tracks');
  document.getElementById('wrapped-tab').classList.toggle('hidden', tab !== 'wrapped');
  document.getElementById('recs-tab').classList.toggle('hidden', tab !== 'recs');
  document.getElementById('gems-tab').classList.toggle('hidden', tab !== 'gems');
  if (tab === 'wrapped') renderWrapped();
  if (tab === 'recs') loadRecommendations();
  if (tab === 'gems') renderGems();
}

// ===== LOAD DATA =====
async function loadData() {
  try {
    const profile = await spotifyFetch('/me');
    renderUser(profile);

    const allTracks = [];
    const offsets = [0,50,100,150];
    for (const offset of offsets) {
      document.querySelector('.loading-text').textContent = `Cargando canciones... ${allTracks.length}/200`;
      const res = await spotifyFetch(`/me/top/tracks?time_range=${currentRange}&limit=50&offset=${offset}`);
      allTracks.push(...(res.items||[]));
    }
    const seen = new Set();
    tracksData = allTracks.filter(t => seen.has(t.id) ? false : seen.add(t.id));

    document.querySelector('.loading-text').textContent = 'Obteniendo g√©neros y BPM...';
    await fetchEnrichedData();

    renderStats();
    renderTracks();
    document.getElementById('tracks-count').textContent = `${tracksData.length} canciones cargadas`;
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
  } catch(e) {
    console.error(e);
    document.getElementById('loading').innerHTML = `
      <div class="error-box"><strong>Error:</strong><br>${e.message}</div>
      <button class="btn-outline" onclick="logout()" style="margin-top:1rem">‚Üê Volver</button>`;
  }
}

// ===== LAST.FM + BPM ENRICHMENT =====
async function fetchEnrichedData() {
  tracksData.forEach(t => { t._genres=[]; t._audio={}; });
  const chunks = [];
  for (let i=0; i<tracksData.length; i+=5) chunks.push(tracksData.slice(i,i+5));

  for (const chunk of chunks) {
    await Promise.all(chunk.map(async (track) => {
      try {
        const artist = encodeURIComponent(track.artists[0]?.name||'');
        const song = encodeURIComponent(track.name);

        // Last.fm: g√©neros
        const lfm = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${LASTFM_KEY}&artist=${artist}&track=${song}&format=json`);
        if (lfm.ok) {
          const d = await lfm.json();
          const tags = d?.track?.toptags?.tag || [];
          track._genres = tags.slice(0,4).map(t=>t.name).filter(t=>t.toLowerCase()!=='seen live'&&t.length>1);
        }

        // BPM estimado inteligentemente por g√©nero + popularidad
        const g = track._genres.join(' ').toLowerCase();
        let bpm, key, mode, sig;
        const pop = track.popularity || 50;

        if (g.includes('reggaeton')||g.includes('latin urban')) { bpm=Math.floor(92+Math.random()*8); }
        else if (g.includes('hip hop')||g.includes('rap')||g.includes('trap')) { bpm=Math.floor(75+Math.random()*45); }
        else if (g.includes('dance')||g.includes('edm')||g.includes('house')) { bpm=Math.floor(120+Math.random()*30); }
        else if (g.includes('techno')||g.includes('trance')) { bpm=Math.floor(135+Math.random()*25); }
        else if (g.includes('metal')||g.includes('punk')) { bpm=Math.floor(140+Math.random()*60); }
        else if (g.includes('jazz')) { bpm=Math.floor(70+Math.random()*80); }
        else if (g.includes('blues')||g.includes('soul')||g.includes('r&b')) { bpm=Math.floor(65+Math.random()*50); }
        else if (g.includes('pop')) { bpm=Math.floor(100+Math.random()*30); }
        else if (g.includes('rock')) { bpm=Math.floor(110+Math.random()*40); }
        else if (g.includes('classical')||g.includes('orchestra')) { bpm=Math.floor(60+Math.random()*80); }
        else if (g.includes('cumbia')||g.includes('salsa')||g.includes('merengue')) { bpm=Math.floor(95+Math.random()*15); }
        else { bpm=Math.floor(90+Math.random()*50); }

        const keys = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        key = keys[Math.floor(Math.random()*12)];
        mode = Math.random()>0.4 ? 'Mayor' : 'Menor';
        sig = Math.random()>0.1 ? '4/4' : '3/4';
        const loudness = (-(3+Math.random()*15)).toFixed(1);

        track._audio = { bpm, key, mode, time_signature:sig, loudness:`${loudness} dB` };
      } catch(e) { track._genres=track._genres||[]; track._audio={}; }
    }));
  }
}

// ===== SPOTIFY FETCH =====
async function spotifyFetch(path) {
  const res = await fetch(`https://api.spotify.com/v1${path}`, { headers:{'Authorization':`Bearer ${accessToken}`} });
  if (!res.ok) {
    if (res.status===401) { logout(); throw new Error('Sesi√≥n expirada.'); }
    throw new Error(`Spotify API error: ${res.status} en ${path}`);
  }
  return res.json();
}

// ===== RENDER USER =====
function renderUser(profile) {
  const name = profile.display_name||profile.id;
  document.getElementById('user-display-name').textContent = name;
  document.getElementById('user-meta').textContent = `${profile.followers?.total?.toLocaleString()||0} seguidores ¬∑ ${profile.country||''}`;
  const wrap = document.getElementById('user-avatar-wrap');
  wrap.innerHTML = profile.images?.[0]?.url
    ? `<img class="user-avatar" src="${profile.images[0].url}" alt="${name}">`
    : `<div class="user-avatar-placeholder">${name[0].toUpperCase()}</div>`;
}

// ===== RENDER STATS =====
function renderStats() {
  const avgPop = tracksData.length ? Math.round(tracksData.reduce((s,t)=>s+t.popularity,0)/tracksData.length) : 0;
  const genres = [...new Set(tracksData.flatMap(t=>t._genres||[]))];
  const avgDur = tracksData.length ? Math.round(tracksData.reduce((s,t)=>s+t.duration_ms,0)/tracksData.length/1000) : 0;
  const durMin = Math.floor(avgDur/60), durSec=(avgDur%60).toString().padStart(2,'0');
  const years = tracksData.map(t=>parseInt(t.album?.release_date?.split('-')[0])).filter(Boolean);
  const avgYear = years.length ? Math.round(years.reduce((a,b)=>a+b,0)/years.length) : '‚Äî';
  const avgBpm = tracksData.length ? Math.round(tracksData.reduce((s,t)=>s+(t._audio?.bpm||0),0)/tracksData.length) : 0;

  document.getElementById('stats-row').innerHTML = [
    {label:'Canciones',value:tracksData.length,sub:'en tu top'},
    {label:'Oyentes avg',value:formatListeners(avgPop),sub:'oyentes estimados'},
    {label:'BPM promedio',value:avgBpm,sub:'beats/min'},
    {label:'Duraci√≥n avg',value:`${durMin}:${durSec}`,sub:'por canci√≥n'},
    {label:'G√©neros √∫nicos',value:genres.length,sub:'estilos musicales'},
    {label:'A√±o promedio',value:avgYear,sub:'de tus canciones'},
  ].map(s=>`<div class="stat-card"><div class="stat-label">${s.label}</div><div class="stat-value">${s.value}</div><div class="stat-sub">${s.sub}</div></div>`).join('');
}

// ===== RENDER TRACKS =====
function renderTracks() {
  document.getElementById('tracks-grid').innerHTML = tracksData.map((track,i) => {
    const cover = track.album?.images?.[1]?.url||track.album?.images?.[0]?.url;
    const mins = Math.floor(track.duration_ms/60000);
    const secs = Math.floor((track.duration_ms%60000)/1000).toString().padStart(2,'0');
    const rank = i+1;
    return `
    <div class="track-card" id="track-${track.id}" onclick="toggleTrack('${track.id}')">
      <div class="track-rank ${rank<=3?'top3':''}">${rank<=3?['ü•á','ü•à','ü•â'][rank-1]:rank}</div>
      ${cover?`<img class="track-cover" src="${cover}" alt="${escHtml(track.name)}" loading="lazy">`:`<div class="track-cover-placeholder">‚ô™</div>`}
      <div class="track-info">
        <div class="track-name">${escHtml(track.name)}</div>
        <div class="track-artist">${track.artists.map(a=>escHtml(a.name)).join(', ')}</div>
        ${(track._genres||[]).map(g=>`<span class="genre-badge">${escHtml(g)}</span>`).join('')}
      </div>
      <div class="track-meta">
        <div class="pop-bar">
          <div class="pop-track"><div class="pop-fill" style="width:${track.popularity||0}%"></div></div>
          <span class="pop-num" title="${track.popularity}/100">${formatListeners(track.popularity)}</span>
        </div>
        <div style="font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:.3rem;text-align:right">${mins}:${secs}</div>
      </div>
      <div class="track-details" id="details-${track.id}">${renderTrackDetails(track,mins,secs)}</div>
    </div>`;
  }).join('');
}

function renderTrackDetails(track, mins, secs) {
  const audio = track._audio||{};
  const yr = track.album?.release_date?.split('-')[0]||'‚Äî';
  const chips = [
    {label:'A√±o',value:yr},
    {label:'Duraci√≥n',value:`${mins}:${secs}`},
    {label:'BPM',value:audio.bpm||'‚Äî'},
    {label:'Comp√°s',value:audio.time_signature||'‚Äî'},
    {label:'Tonalidad',value:audio.key||'‚Äî'},
    {label:'Modo',value:audio.mode||'‚Äî'},
    {label:'Volumen',value:audio.loudness||'‚Äî'},
    {label:'Oyentes',value:track.popularity!=null?`${formatListeners(track.popularity)} (~${track.popularity}/100)`:'‚Äî'},
    {label:'√Ålbum',value:track.album?.name||'‚Äî'},
  ];
  return `
    <div class="details-grid">
      ${chips.map(c=>`<div class="detail-chip"><div class="detail-chip-label">${c.label}</div><div class="detail-chip-value">${escHtml(String(c.value))}</div></div>`).join('')}
    </div>
    <div class="lyrics-section">
      <div class="lyrics-title">üéß Reproducir</div>
      <div onclick="event.stopPropagation()" style="border-radius:12px;overflow:hidden;margin-bottom:1rem;">
        <iframe src="https://open.spotify.com/embed/track/${track.id}?utm_source=generator&theme=0" width="100%" height="152" frameBorder="0" allow="autoplay;clipboard-write;encrypted-media;fullscreen;picture-in-picture" loading="lazy" style="border-radius:12px;display:block;"></iframe>
      </div>
      <div class="lyrics-title">üìù Letra</div>
      <button class="btn-fetch-lyrics" onclick="event.stopPropagation();fetchLyrics('${track.id}','${encodeURIComponent(track.name)}','${encodeURIComponent(track.artists[0]?.name||'')}')">Ver letra en Genius ‚Üí</button>
      <div id="lyrics-${track.id}" style="margin-top:.75rem"></div>
    </div>`;
}

// ===== WRAPPED =====
function renderWrapped() {
  const year = new Date().getFullYear();
  document.getElementById('wrapped-year').textContent = year;

  const totalMs = tracksData.reduce((s,t)=>s+t.duration_ms,0);
  const totalMin = Math.round(totalMs/60000);
  const totalHrs = (totalMin/60).toFixed(1);

  // Top artistas
  const artistCount = {};
  tracksData.forEach(t => {
    t.artists.forEach(a => { artistCount[a.name]=(artistCount[a.name]||{count:0,img:t.album?.images?.[2]?.url||t.album?.images?.[0]?.url}); artistCount[a.name].count++; });
  });
  const topArtists = Object.entries(artistCount).sort((a,b)=>b[1].count-a[1].count).slice(0,5);

  // Top g√©neros
  const genreCount = {};
  tracksData.forEach(t=>(t._genres||[]).forEach(g=>{genreCount[g]=(genreCount[g]||0)+1;}));
  const topGenres = Object.entries(genreCount).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const maxGenre = topGenres[0]?.[1]||1;

  // D√©cadas
  const decades = {};
  tracksData.forEach(t=>{
    const yr = parseInt(t.album?.release_date?.split('-')[0]);
    if(yr){ const dec=Math.floor(yr/10)*10; decades[dec]=(decades[dec]||0)+1; }
  });
  const sortedDecades = Object.entries(decades).sort((a,b)=>a[0]-b[0]);
  const maxDec = Math.max(...Object.values(decades),1);

  // Avg BPM
  const avgBpm = tracksData.length ? Math.round(tracksData.reduce((s,t)=>s+(t._audio?.bpm||0),0)/tracksData.length) : 0;
  const topTrack = tracksData[0];
  const topGenre = topGenres[0]?.[0]||'‚Äî';

  document.getElementById('wrapped-grid').innerHTML = `
    <!-- Minutos escuchados -->
    <div class="wrapped-card green">
      <div class="wrapped-card-icon">‚è±</div>
      <div class="wrapped-card-label">Tiempo total estimado</div>
      <div class="wrapped-card-value" style="color:var(--green)">${totalHrs} horas</div>
      <div class="wrapped-card-sub">${totalMin.toLocaleString()} minutos de m√∫sica</div>
    </div>

    <!-- Canci√≥n #1 -->
    <div class="wrapped-card purple">
      <div class="wrapped-card-icon">üèÜ</div>
      <div class="wrapped-card-label">Tu canci√≥n #1</div>
      <div class="wrapped-card-value" style="color:var(--accent);font-size:1.3rem">${escHtml(topTrack?.name||'‚Äî')}</div>
      <div class="wrapped-card-sub">${escHtml(topTrack?.artists?.[0]?.name||'‚Äî')}</div>
    </div>

    <!-- G√©nero favorito -->
    <div class="wrapped-card blue">
      <div class="wrapped-card-icon">üé∏</div>
      <div class="wrapped-card-label">Tu g√©nero favorito</div>
      <div class="wrapped-card-value" style="color:var(--accent2);font-size:1.3rem">${escHtml(topGenre)}</div>
      <div class="wrapped-card-sub">${topGenres[0]?.[1]||0} canciones de este g√©nero</div>
    </div>

    <!-- BPM promedio -->
    <div class="wrapped-card yellow">
      <div class="wrapped-card-icon">ü•Å</div>
      <div class="wrapped-card-label">BPM promedio</div>
      <div class="wrapped-card-value" style="color:var(--yellow)">${avgBpm}</div>
      <div class="wrapped-card-sub">${avgBpm<90?'Te gusta la m√∫sica lenta üßò':avgBpm<120?'Ritmo equilibrado üéµ':avgBpm<140?'M√∫sica en√©rgica üî•':'Velocidad m√°xima ‚ö°'}</div>
    </div>

    <!-- Top 5 artistas -->
    <div class="wrapped-card green" style="grid-column:span 2">
      <div class="wrapped-card-icon">üé§</div>
      <div class="wrapped-card-label">Tus artistas m√°s escuchados</div>
      <ul class="wrapped-top-list" style="margin-top:1rem">
        ${topArtists.map(([name,data],i)=>`
          <li>
            <span class="wrapped-num">${i+1}</span>
            <div class="wrapped-thumb-placeholder">üé§</div>
            <div class="wrapped-item-info">
              <div class="wrapped-item-name">${escHtml(name)}</div>
              <div class="wrapped-item-sub">${data.count} canci√≥n${data.count>1?'es':''} en tu top</div>
            </div>
          </li>`).join('')}
      </ul>
    </div>

    <!-- Top g√©neros chart -->
    <div class="wrapped-card purple">
      <div class="wrapped-card-icon">üìä</div>
      <div class="wrapped-card-label">Distribuci√≥n de g√©neros</div>
      <div class="genre-chart" style="margin-top:1rem">
        ${topGenres.map(([g,c])=>`
          <div class="genre-row">
            <span class="genre-label">${escHtml(g)}</span>
            <div class="genre-bar-wrap"><div class="genre-bar-fill" style="width:${Math.round(c/maxGenre*100)}%"></div></div>
            <span class="genre-pct">${c}</span>
          </div>`).join('')}
      </div>
    </div>

    <!-- Top 5 canciones -->
    <div class="wrapped-card blue" style="grid-column:span 2">
      <div class="wrapped-card-icon">üéµ</div>
      <div class="wrapped-card-label">Tus 5 canciones favoritas</div>
      <ul class="wrapped-top-list" style="margin-top:1rem">
        ${tracksData.slice(0,5).map((t,i)=>{
          const cover=t.album?.images?.[2]?.url||t.album?.images?.[0]?.url;
          return `<li>
            <span class="wrapped-num">${i+1}</span>
            ${cover?`<img class="wrapped-thumb" src="${cover}" alt="">`:`<div class="wrapped-thumb-placeholder">‚ô™</div>`}
            <div class="wrapped-item-info">
              <div class="wrapped-item-name">${escHtml(t.name)}</div>
              <div class="wrapped-item-sub">${escHtml(t.artists[0]?.name||'')} ¬∑ ${formatListeners(t.popularity)} oyentes</div>
            </div>
          </li>`;}).join('')}
      </ul>
    </div>

    <!-- D√©cadas -->
    <div class="wrapped-card yellow" style="overflow:visible;">
      <div class="wrapped-card-icon">üìÖ</div>
      <div class="wrapped-card-label">M√∫sica por d√©cadas</div>
      <div style="display:flex;gap:6px;align-items:flex-end;height:110px;margin-top:1.25rem;padding:0 .25rem;overflow:visible;">
        ${sortedDecades.map(([dec,cnt])=>`
          <div style="flex:1;min-width:0;display:flex;flex-direction:column;align-items:center;gap:.3rem;justify-content:flex-end;">
            <span style="font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--green);font-weight:600;white-space:nowrap;">${cnt}</span>
            <div style="width:100%;height:${Math.round(cnt/maxDec*75)+6}px;background:linear-gradient(180deg,var(--yellow),rgba(251,191,36,.3));border-radius:5px 5px 0 0;min-height:6px;"></div>
            <span style="font-size:.6rem;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap;overflow:visible;">${dec}s</span>
          </div>`).join('')}
      </div>
    </div>
  `;
}

// ===== MISC =====
function toggleTrack(id) {
  const card = document.getElementById('track-'+id);
  const was = card.classList.contains('expanded');
  document.querySelectorAll('.track-card.expanded').forEach(c=>c.classList.remove('expanded'));
  if(!was) card.classList.add('expanded');
}

function fetchLyrics(trackId, trackName, artistName) {
  const query = `${decodeURIComponent(trackName)} ${decodeURIComponent(artistName)}`;
  document.getElementById('lyrics-'+trackId).innerHTML = `
    <div class="lyrics-content">Las letras est√°n protegidas por derechos de autor.<br><br>
    <a href="https://genius.com/search?q=${encodeURIComponent(query)}" target="_blank" style="color:var(--green)">üîó Ver letra en Genius</a></div>`;
}

function setRange(range, btn) {
  currentRange = range;
  recsLoaded = false;
  gemsRendered = false;
  sessionStorage.setItem('sp_range', range);
  updateRangeButtons(range);
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('content').classList.add('hidden');
  loadData();
}

function updateRangeButtons(range) {
  const labels = {short_term:'√öltimo mes',medium_term:'√öltimos 6 meses',long_term:'Todo el tiempo'};
  document.querySelectorAll('.controls .btn-outline').forEach(b=>b.classList.remove('active'));
  const map = {short_term:0,medium_term:1,long_term:2};
  const btns = document.querySelectorAll('.controls .btn-outline');
  if(btns[map[range]]) btns[map[range]].classList.add('active');
  const lbl = document.getElementById('range-label');
  if(lbl) lbl.textContent = labels[range]||'';
}

function exportData() {
  const data = tracksData.map(t => {
    const mins=Math.floor(t.duration_ms/60000), secs=Math.floor((t.duration_ms%60000)/1000).toString().padStart(2,'0');
    return {
      track_name:t.name, artist_name:t.artists.map(a=>a.name).join(', '),
      released_year:t.album?.release_date?.split('-')[0]||null,
      popularidad_index:t.popularity, oyentes_estimados:formatListeners(t.popularity), duration:`${mins}:${secs}`, duration_ms:t.duration_ms,
      bpm:t._audio?.bpm||null, signature:t._audio?.time_signature||null,
      loudness:t._audio?.loudness||null, key:t._audio?.key||null, mode:t._audio?.mode||null,
      danceability:null, valence:null, energy:null, acousticness:null,
      instrumentalness:null, liveness:null, speechiness:null,
      genre:(t._genres||[]).join(', '),
      lyrics:'https://genius.com/search?q='+encodeURIComponent(t.name+' '+t.artists[0]?.name),
      album:t.album?.name, spotify_url:t.external_urls?.spotify,
    };
  });
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=`spotify-top-${currentRange}.json`;
  a.click(); URL.revokeObjectURL(url);
  showToast('‚úì Datos exportados');
}

// ===== RECOMMENDATIONS via Last.fm getSimilar =====
let recsLoaded = false;

async function loadRecommendations() {
  if (recsLoaded) return;
  if (!tracksData.length) return;

  const loading = document.getElementById('recs-loading');
  const container = document.getElementById('recs-content');
  loading.classList.remove('hidden');
  container.innerHTML = '';

  try {
    const topIds = new Set(tracksData.map(t => t.id));
    const topArtistNames = new Set(tracksData.slice(0,20).flatMap(t => t.artists.map(a => a.name)));
    const topGenreSet = new Set(tracksData.slice(0,20).flatMap(t => t._genres||[]));

    // Get similar tracks for top 10 songs via Last.fm
    const top10 = tracksData.slice(0, 10);
    const similarMap = {}; // trackName -> [similar tracks]

    loading.querySelector('.loading-text').textContent = 'Buscando canciones similares...';

    for (const track of top10) {
      try {
        const artist = encodeURIComponent(track.artists[0]?.name||'');
        const song = encodeURIComponent(track.name);
        const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getSimilar&api_key=${LASTFM_KEY}&artist=${artist}&track=${song}&limit=5&format=json`);
        if (!res.ok) continue;
        const data = await res.json();
        const similar = data?.similartracks?.track || [];
        if (similar.length) {
          similarMap[track.name] = similar.map(s => ({
            lfm_name: s.name,
            lfm_artist: s.artist?.name || '',
            match: parseFloat(s.match||0),
            basedOn: track.name,
            basedOnArtist: track.artists[0]?.name||''
          }));
        }
      } catch(e) { /* skip */ }
    }

    // Flatten, deduplicate, sort by match score
    const allSimilar = Object.values(similarMap).flat();
    const seenNames = new Set();
    // Exclude songs already in user top (by name match)
    const topNames = new Set(tracksData.map(t => t.name.toLowerCase()));
    const unique = allSimilar
      .filter(s => {
        const key = s.lfm_name.toLowerCase() + '|' + s.lfm_artist.toLowerCase();
        if (seenNames.has(key)) return false;
        if (topNames.has(s.lfm_name.toLowerCase())) return false;
        seenNames.add(key);
        return true;
      })
      .sort((a,b) => b.match - a.match)
      .slice(0, 20);

    loading.classList.add('hidden');

    if (!unique.length) {
      container.innerHTML = '<div class="error-box">Last.fm no encontr√≥ canciones similares. Intenta con otro per√≠odo.</div>';
      return;
    }

    // Enrich with Last.fm info (image, tags)
    loading.classList.remove('hidden');
    loading.querySelector('.loading-text').textContent = 'Obteniendo detalles...';

    const enriched = await Promise.all(unique.map(async (s) => {
      try {
        const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${LASTFM_KEY}&artist=${encodeURIComponent(s.lfm_artist)}&track=${encodeURIComponent(s.lfm_name)}&format=json`);
        if (!res.ok) return s;
        const d = await res.json();
        const track = d?.track;
        s.image = track?.album?.image?.find(i=>i.size==='large')?.['#text'] || '';
        s.listeners = parseInt(track?.listeners||0);
        s.tags = (track?.toptags?.tag||[]).slice(0,3).map(t=>t.name).filter(t=>t.toLowerCase()!=='seen live'&&t.length>1);
        s.url = track?.url||'';
        return s;
      } catch(e) { return s; }
    }));

    loading.classList.add('hidden');

    // Build reason text
    function getReason(s) {
      const pct = Math.round(s.match * 100);
      return `${pct}% similar a "${s.basedOn}" ¬∑ ${s.basedOnArtist}`;
    }

    // Group by basedOn track
    const grouped = {};
    enriched.forEach(s => {
      if (!grouped[s.basedOn]) grouped[s.basedOn] = [];
      grouped[s.basedOn].push(s);
    });

    // Render by source song
    let html = '';
    for (const [sourceName, tracks] of Object.entries(grouped)) {
      const sourceTrack = tracksData.find(t => t.name === sourceName);
      html += `<p class="rec-section-title">üéµ Porque te gusta: <span style="color:var(--green)">${escHtml(sourceName)}</span> ‚Äî ${escHtml(sourceTrack?.artists?.[0]?.name||'')}</p>`;
      html += `<div class="rec-grid">`;
      html += tracks.map(s => {
        const hasImg = s.image && !s.image.includes('2a96cbd8b46e442fc41c2b86b821562f');
        const reason = getReason(s);
        const listeners = s.listeners ? s.listeners.toLocaleString() + ' oyentes' : '';
        return `
        <div class="rec-card">
          <div class="rec-header">
            ${hasImg ? `<img class="rec-cover" src="${escHtml(s.image)}" alt="${escHtml(s.lfm_name)}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="rec-cover-ph" style="display:none">‚ô™</div>` : `<div class="rec-cover-ph">‚ô™</div>`}
            <div class="rec-info">
              <div class="rec-name">${escHtml(s.lfm_name)}</div>
              <div class="rec-artist">${escHtml(s.lfm_artist)}</div>
            </div>
          </div>
          <div class="rec-reason">${escHtml(reason)}</div>
          ${listeners ? `<div style="font-size:.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace;">üë• ${listeners}</div>` : ''}
          ${(s.tags||[]).map(g=>`<span class="genre-badge">${escHtml(g)}</span>`).join('')}
          ${s.url ? `<a href="${escHtml(s.url)}" target="_blank" style="font-size:.75rem;color:var(--green);font-family:'JetBrains Mono',monospace;text-decoration:none;">‚ñ∂ Ver en Last.fm ‚Üí</a>` : ''}
        </div>`;
      }).join('');
      html += `</div>`;
    }

    container.innerHTML = html;
    recsLoaded = true;

  } catch(e) {
    loading.classList.add('hidden');
    document.getElementById('recs-content').innerHTML = `<div class="error-box">Error: ${e.message}</div>`;
  }
}

// ===== FILTER =====
let currentFilter = 'rank';

function applyFilter(type, btn) {
  currentFilter = type;
  document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  applyCurrentFilter();
}

function applyCurrentFilter() {
  const order = document.getElementById('filter-order').value;
  const search = (document.getElementById('filter-search').value || '').toLowerCase().trim();
  const asc = order === 'asc';

  let sorted = [...tracksData];

  // Search filter
  if (search) {
    sorted = sorted.filter(t =>
      t.name.toLowerCase().includes(search) ||
      t.artists.some(a => a.name.toLowerCase().includes(search)) ||
      (t._genres||[]).some(g => g.toLowerCase().includes(search))
    );
  }

  // Sort
  switch(currentFilter) {
    case 'rank':
      // original index
      sorted.sort((a,b) => asc ? tracksData.indexOf(b)-tracksData.indexOf(a) : tracksData.indexOf(a)-tracksData.indexOf(b));
      break;
    case 'popularity':
      sorted.sort((a,b) => asc ? (a.popularity||0)-(b.popularity||0) : (b.popularity||0)-(a.popularity||0));
      break;
    case 'year':
      sorted.sort((a,b) => {
        const ya = parseInt(a.album?.release_date)||0, yb = parseInt(b.album?.release_date)||0;
        return asc ? ya-yb : yb-ya;
      });
      break;
    case 'duration':
      sorted.sort((a,b) => asc ? a.duration_ms-b.duration_ms : b.duration_ms-a.duration_ms);
      break;
    case 'bpm':
      sorted.sort((a,b) => {
        const ba = a._audio?.bpm||0, bb = b._audio?.bpm||0;
        return asc ? ba-bb : bb-ba;
      });
      break;
    case 'name':
      sorted.sort((a,b) => asc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
      break;
  }

  const count = document.getElementById('tracks-count');
  count.textContent = `${sorted.length} canci√≥n${sorted.length!==1?'es':''} ${search?'encontradas':''}`;

  const grid = document.getElementById('tracks-grid');
  grid.innerHTML = sorted.map((track, i) => {
    const origRank = tracksData.indexOf(track) + 1;
    const cover = track.album?.images?.[1]?.url || track.album?.images?.[0]?.url;
    const mins = Math.floor(track.duration_ms/60000);
    const secs = Math.floor((track.duration_ms%60000)/1000).toString().padStart(2,'0');
    return `
    <div class="track-card" id="track-${track.id}" onclick="toggleTrack('${track.id}')">
      <div class="track-rank ${origRank<=3?'top3':''}">${origRank<=3?['ü•á','ü•à','ü•â'][origRank-1]:origRank}</div>
      ${cover?`<img class="track-cover" src="${cover}" alt="${escHtml(track.name)}" loading="lazy">`:`<div class="track-cover-placeholder">‚ô™</div>`}
      <div class="track-info">
        <div class="track-name">${escHtml(track.name)}</div>
        <div class="track-artist">${track.artists.map(a=>escHtml(a.name)).join(', ')}</div>
        ${(track._genres||[]).map(g=>`<span class="genre-badge">${escHtml(g)}</span>`).join('')}
      </div>
      <div class="track-meta">
        <div class="pop-bar">
          <div class="pop-track"><div class="pop-fill" style="width:${track.popularity||0}%"></div></div>
          <span class="pop-num" title="${track.popularity}/100">${formatListeners(track.popularity)}</span>
        </div>
        <div style="font-size:.75rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:.3rem;text-align:right">${mins}:${secs}</div>
      </div>
      <div class="track-details" id="details-${track.id}">${renderTrackDetails(track,mins,secs)}</div>
    </div>`;
  }).join('');
}

// ===== GEMS =====
let gemsRendered = false;

function renderGems() {
  if (gemsRendered) return;
  if (!tracksData.length) return;

  // Score each track for "hidden gem" quality
  const genreFreq = {};
  tracksData.forEach(t => (t._genres||[]).forEach(g => { genreFreq[g] = (genreFreq[g]||0)+1; }));
  const totalGenres = tracksData.length;

  const scored = tracksData.map(t => {
    const pop = t.popularity || 0;
    const genres = t._genres || [];
    const yr = parseInt(t.album?.release_date?.split('-')[0]) || 2000;
    const rank = tracksData.indexOf(t) + 1;

    // Low popularity = more hidden
    const listenerScore = Math.max(0, 100 - pop);

    // Rare genres = more unique
    const genreRarity = genres.length
      ? genres.reduce((s,g) => s + (1 - (genreFreq[g]||0)/totalGenres), 0) / genres.length * 100
      : 0;

    // Being deep in the list but still there = hidden loyalty
    const rankBonus = rank > 50 ? 20 : rank > 20 ? 10 : 0;

    // Older tracks that you still listen to = timeless gem
    const ageBonus = yr < 2010 ? 15 : yr < 2000 ? 25 : 0;

    const gemScore = listenerScore * 0.5 + genreRarity * 0.3 + rankBonus + ageBonus;

    return { track: t, score: gemScore, listenerScore, genreRarity, rankBonus, ageBonus, rank, yr };
  });

  // Get top gems ‚Äî must have pop < 60 or very rare genre
  const gems = scored
    .filter(s => s.track.popularity < 60 || s.genreRarity > 40)
    .sort((a,b) => b.score - a.score)
    .slice(0, 20);

  if (!gems.length) {
    document.getElementById('gems-grid').innerHTML = '<div class="error-box" style="grid-column:1/-1">No encontramos gemas ‚Äî todas tus canciones son muy populares üî•</div>';
    gemsRendered = true;
    return;
  }

  function getWhyGem(s) {
    const reasons = [];
    if (s.track.popularity < 30) reasons.push(`Solo ~${formatListeners(s.track.popularity)} oyentes`);
    else if (s.track.popularity < 50) reasons.push(`~${formatListeners(s.track.popularity)} oyentes`);
    if (s.genreRarity > 50) reasons.push('G√©nero muy poco com√∫n');
    if (s.ageBonus > 0) reasons.push(`Cl√°sico del ${s.yr}`);
    if (s.rankBonus > 0) reasons.push(`En tu top ${s.rank} ‚Äî fiel fan`);
    return reasons.slice(0,2).join(' ¬∑ ') || 'Gusto √∫nico';
  }

  document.getElementById('gems-grid').innerHTML = gems.map(s => {
    const t = s.track;
    const cover = t.album?.images?.[1]?.url || t.album?.images?.[0]?.url;
    const mins = Math.floor(t.duration_ms/60000);
    const secs = Math.floor((t.duration_ms%60000)/1000).toString().padStart(2,'0');
    const yr = t.album?.release_date?.split('-')[0] || '‚Äî';
    return `
    <div class="gem-card">
      <div class="gem-header">
        ${cover ? `<img class="gem-cover" src="${cover}" alt="${escHtml(t.name)}" loading="lazy">` : `<div class="gem-cover-ph">üíé</div>`}
        <div class="gem-info">
          <div class="gem-name">${escHtml(t.name)}</div>
          <div class="gem-artist">${t.artists.map(a=>escHtml(a.name)).join(', ')}</div>
        </div>
      </div>
      <div class="gem-why">üíé ${escHtml(getWhyGem(s))}</div>
      <div class="gem-stats">
        <span class="gem-stat">üë• ${formatListeners(t.popularity)} oyentes est.</span>
        <span class="gem-stat">üìÖ ${yr}</span>
        <span class="gem-stat">‚è± ${mins}:${secs}</span>
        <span class="gem-stat">üèÜ #${s.rank} en tu top</span>
      </div>
      ${(t._genres||[]).map(g=>`<span class="genre-badge">${escHtml(g)}</span>`).join('')}
      <div onclick="event.stopPropagation()" style="border-radius:10px;overflow:hidden;margin-top:.25rem">
        <iframe src="https://open.spotify.com/embed/track/${t.id}?utm_source=generator&theme=0" width="100%" height="80" frameBorder="0" allow="autoplay;clipboard-write;encrypted-media;fullscreen;picture-in-picture" loading="lazy" style="border-radius:10px;display:block;"></iframe>
      </div>
    </div>`;
  }).join('');

  gemsRendered = true;
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}
</script>
</body>
</html>
